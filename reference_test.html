<head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css">
<!--        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>-->

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />

    <link rel="stylesheet" href="css/l.geosearch.mod.css" />
<!--  <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>-->

<!--
      <script src="js/l.control.geosearch.mod.js">  </script>
      <script src="js/l.geosearch.provider.google.js">  </script>
-->
 

    </head>


<body>
<div id="map"></div>
    <div id="layer_selector" class="cartodb-infobox">
      <ul>
          
        <li id="streets" class="streets">Streets</li>
        <li id="sat" class="sat">Satellite</li>
    
      </ul>

    </div>
    
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>
          <script src="js/l.control.geosearch.mod.js">  </script>
      <script src="js/l.geosearch.provider.google.js">  </script>
      <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>

<script>
// get the viz.json url from the CartoDB Editor
// - click on visualize
// - create new visualization
// - make visualization public
// - click on publish
// - go to API tab

window.onload = function initialize() {

    
         var reference = L.tileLayer('http://a.tiles.mapbox.com/v3/nzlur.33ed1f4a/{z}/{x}/{y}.png', {zIndex: 150});
          
    function openInfowindow(layer, latlng, cartodb_id) {
        layer.trigger('featureClick', null, latlng, null, { cartodb_id: cartodb_id }, 0);
      };
 
        

cartodb.createVis('map', 'http://nzlur.cartodb.com/api/v2/viz/00f582aa-824c-11e4-886f-0e018d66dc29/viz.json', {
    scrollwheel: false,
        tiles_loader: true,
    cartodb_logo: false,
    zoom: 13
  })
  
  .done(function (vis, layers, layer) {
//get native leaflet map for basemap selector tool//WORKS BUT CANNOT ADD LEAFLET LAYER CONTROLLER
var basemap = layers[0];
    var zoningmap = layers[1];
    var redev = layers[1].getSubLayer(2);
    console.log(redev);
//    redev.SetZIndex(4);
//    zoningmap.layer.setZindex(4);
//    console.log(zoningmap);
//    console.log(basemap);
    var map = vis.getNativeMap();
//    console.log(map);
    map.addLayer(reference);
//map.setZoom(14);
     map.on("geosearch_showlocation", function(data) {
//                console.log(data.Location.Y, data.Location.X);
               var lat = (data.Location.Y);
                var lng = (data.Location.X);
                
                function getCartdb_id(latlng) {
         $.getJSON("http://nzlur.cartodb.com/api/v2/sql?q=SELECT%20cartodb_id%20FROM%20zoning%20where%20ST_intersects(the_geom,%20cdb_latlng("+lat+","+lng+"))", function(data) {
  var items = data.rows[0];
               
                // Find the last index and the last item.
                var cartodb_id = items.cartodb_id;
             map.setView([lat, lng], 17, false);
                                 openInfowindow(zoningmap, [lat, lng], cartodb_id);

             //add more styling with coordinates, cdb_id
             //setcartoCSS
  });
        };
               getCartdb_id();
          });
    
      new L.Control.GeoSearch({
           provider: new L.GeoSearch.Provider.Google({
//               region: region
//               componentRestrictions: {"administrativeArea":"NJ", "locality":"Newark"}
               componentRestrictions: {"locality":"Newark"}

           }),
           position: 'topcenter'
       }).addTo(map);
    
    selectedStyle = $('li.selected').attr('id');

    createSelector(map);


    
      function createSelector(layers) {
//        var sql = new cartodb.SQL({ user: 'zenontc' });

        var $options = $('#layer_selector li');
        $options.click(function(e) {
          // get the area of the selected layer
          var $li = $(e.target);
          var id = $li.attr('id');
          if(id == 'sat' ){
//              access_token=pk.eyJ1IjoibnpsdXIiLCJhIjoiUFh0MzlIWSJ9.1mVHwMcRhliArgC-uE9S1w
            // change the basemap url in the layer[0] to toggle to sat img
            // MUST APPLY SELECTED STYLE TO "SATTELITE BUTTON", push style in click event?
console.log("satellite layer selected");
var changetoSat = basemap.setUrl('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
//              , {
//	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
//});');
              
//              map.setZoom(14);
 selectedStyle = id;
          };
            
            if(id == 'streets' ){
            // change the basemap url in the layer[0] to toggle back to mapbox 
console.log("streets layer selected");
var changetoStreets = basemap.setUrl("http://a.tiles.mapbox.com/v4/nzlur.kgh9n3dp/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibnpsdXIiLCJhIjoiUFh0MzlIWSJ9.1mVHwMcRhliArgC-uE9S1w");
//    var addRef = map.addLayer(reference);
            selectedStyle = id;
          }
            
        });
      }
    
});
}
</script>
    </body>
